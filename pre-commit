#!/bin/bash

# Pre-commit hook to enforce clang-format
# This hook prevents commits if any C/C++ files are not properly formatted

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Check if clang-format is installed
if ! command -v clang-format &> /dev/null; then
    echo -e "${RED}Error: clang-format is not installed!${NC}"
    echo "Please install clang-format before committing."
    exit 1
fi

# Get the list of staged C/C++ files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(c|cpp|cc|cxx|h|hpp|hxx)$' || true)

if [ -z "$STAGED_FILES" ]; then
    # No C/C++ files staged, allow commit
    exit 0
fi

echo -e "${YELLOW}Checking clang-format on staged files...${NC}"

UNFORMATTED_FILES=()
TEMP_DIR=$(mktemp -d)

# Check each staged file
for FILE in $STAGED_FILES; do
    # Get the staged content (not the working directory content)
    STAGED_CONTENT=$(git show ":$FILE")
    
    # Format the staged content
    FORMATTED_CONTENT=$(echo "$STAGED_CONTENT" | clang-format --assume-filename="$FILE")
    
    # Compare staged content with formatted content
    if [ "$STAGED_CONTENT" != "$FORMATTED_CONTENT" ]; then
        UNFORMATTED_FILES+=("$FILE")
    fi
done

# Clean up temp directory
rm -rf "$TEMP_DIR"

# If there are unformatted files, reject the commit
if [ ${#UNFORMATTED_FILES[@]} -ne 0 ]; then
    echo -e "${RED}Error: The following files are not formatted with clang-format:${NC}"
    for FILE in "${UNFORMATTED_FILES[@]}"; do
        echo -e "  ${RED}✗${NC} $FILE"
    done
    echo ""
    echo -e "${YELLOW}Please format these files before committing:${NC}"
    echo ""
    echo "  # Format a single file:"
    echo "  clang-format -i <file>"
    echo ""
    echo "  # Format all staged files:"
    echo "  git diff --cached --name-only --diff-filter=ACM | grep -E '\.(c|cpp|cc|cxx|h|hpp|hxx)$' | xargs clang-format -i"
    echo ""
    echo "  # Then stage the formatted files:"
    echo "  git add <files>"
    echo ""
    exit 1
fi

echo -e "${GREEN}✓ All staged C/C++ files are properly formatted!${NC}"
exit 0
